import torch
import transformers
import json
import re

class Llama3:
    def __init__(self, model_path):
        self.model_id = model_path
        self.pipeline = transformers.pipeline(
            "text-generation",
            model=self.model_id,
            model_kwargs={
                "torch_dtype": torch.float16,
                "quantization_config": {"load_in_4bit": True},
                "low_cpu_mem_usage": True,
            },
        )

    def generate_qa(self, context, num_pairs, max_tokens=512, temperature=0.7, top_p=0.9):
        # Prepare the prompt using context
        prompt = f"""निम्नलिखित संदर्भ के आधार पर, {num_pairs} प्रश्न-उत्तर जोड़े उत्पन्न करें जो शैली और विषय-वस्तु में समान हों:
            संदर्भ: {context}
            {num_pairs} समान नए प्रश्न-उत्तर जोड़े उत्पन्न करें:
            """
        
        outputs = self.pipeline(
            prompt,
            max_new_tokens=max_tokens,
            eos_token_id=self.pipeline.tokenizer.eos_token_id,
            do_sample=True,
            temperature=temperature,
            top_p=top_p,
            repetition_penalty=1.1,
            num_return_sequences=1,
        )
        qa_text = outputs[0]["generated_text"][len(prompt):].strip()

        qa_pairs = []
        qa_lines = qa_text.split("\n")
        for i in range(0, len(qa_lines), 2):
            if i + 1 < len(qa_lines):
                question = qa_lines[i].replace("प्रश्न", "").strip()
                answer = qa_lines[i + 1].replace("उत्तर", "").strip()
                qa_pairs.append({"question": question, "answer": answer})
            if len(qa_pairs) == num_pairs:
                break

        return qa_pairs

    def save_to_json(self, context, qa_pairs, file_name="generated_qa_pairs.json"):
        data = {
            "context": context,
            "qa_pairs": qa_pairs,
        }
        with open(file_name, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=4)
        print(f"QA pairs saved to '{file_name}'.")

if __name__ == "__main__":
    bot = Llama3("/home/ubuntu/harsh/harsh-project/quantized_fine_tuned_llama/")
   
    context = """दलाई लामा ने अपनी संवेदना और प्रार्थना व्यक्त की और कलाम की मौत को \"एक अपूरणीय क्षति\" बुला, अपना दुख व्यक्त किया। उन्होंने यह भी कहा, \"अनेक वर्षों में, मुझे कई अवसरों पर कलाम के साथ बातचीत करने का मौका मिला। वह एक महान वैज्ञानिक, शिक्षाविद और राजनेता ही नहीं, बल्कि वे एक वास्तविक सज्जन थे, और हमेशा मैंने उनकी सादगी और विनम्रता की प्रशंसा की है। मैंने सामान्य हितों के विषयों की एक विस्तृत श्रृंखला पर हमारी चर्चाओं का आनंद लिया, लेकिन विज्ञान, अध्यात्म और शिक्षा के साथ मुख्य रूप से हमारे बीच चिंतन किया जाता था। \" दक्षिण एशियाई नेताओं ने अपनी संवेदना व्यक्त की और दिवंगत राजनेता की सराहना की। भूटान सरकार ने कलाम की मौत के शोक के लिए देश के झंडे को आधी ऊंचाई पर फहराने के लिए आदेश दिया, और श्रद्धांजलि में 1000 मक्खन के दीपक की भेंट किए। भूटान के प्रधानमंत्री शेरिंग तोबगे ने कलाम के प्रति अपना गहरा दुख व्यक्त करते हुए कहा, \"वे एक महान नेता थे जिनकी सभी ने प्रशंसा की विशेषकर भारत के युवाओं के वे प्रशंसनीय नेता थे जिन्हें वे जनता का राष्ट्रपति बुलाते थे। \"बांग्लादेश की प्रधानमंत्री शेख हसीना ने उनकी व्याख्या करते हुए कहा, \"एक महान राजनेता प्रशंसित वैज्ञानिक और दक्षिण एशिया के युवा पीढ़ी के लिए प्रेरणा स्रोत के संयोग\" उन्होंने कलाम की मृत्यु को \"भारत के लिए अपूरणीय क्षति से भी परे बताया। \" उन्होंने यह भी कहा कि भारत के सबसे प्रसिद्ध बेटे, पूर्व राष्ट्रपति के निधन पर हमें गहरा झटका लगा है। ए॰पी॰जे॰ अब्दुल कलाम अपने समय के सबसे महान ज्ञानियों में से एक थे। वह बांग्लादेश में भी बहुत सम्मानित थे। उनकी विज्ञान और प्रौद्योगिकी के क्षेत्र में भारत की वृद्धि करने के लिए अमूल्य योगदान के लिए वे सभी के द्वारा हमेशा याद किये जायेंगे। वे दक्षिण एशिया की युवा पीढ़ी के लिए प्रेरणा का स्रोत थे जो उनके सपनों को पंख देते थे। \" बांग्लादेश नेशनलिस्ट पार्टी की प्रमुख खालिदा जिया ने कहा, \"एक परमाणु वैज्ञानिक के रूप में, उन्होंने लोगों के कल्याण में स्वयं को समर्पित किया। \"अफगानिस्तान के राष्ट्रपति अशरफ गनी, ने कलाम को, \"लाखों लोगों के लिए एक प्रेरणादायक शख्सियत बताया\" ये नोट करते हुए \"हमे अपने जीवन से बहुत कुछ सीखना है। \" नेपाली प्रधानमंत्री सुशील कोइराला ने भारत के लिए कलाम के वैज्ञानिक योगदानों को याद किया। \"नेपाल ने एक अच्छा दोस्त खो दिया है और मैंने एक सम्मानित और आदर्श व्यक्तित्व को खो दिया है। \"पाकिस्तान के राष्ट्रपति, ममनून हुसैन और पाकिस्तान के प्रधानमंत्री नवाज शरीफ ने पूर्व राष्ट्रपति के निधन पर उनके प्रति दु: ख, शोक व संवेदना व्यक्त की। श्रीलंका के राष्ट्रपति मैत्रिपाला सिरिसेना ने कहा, \"कलाम दृढ़ विश्वास और अदम्य भावना के आदमी थे। मैंने उन्हें दुनिया के एक उत्कृष्ट राजनेता के रूप में देखा था। उनकी मौत भारत के लिए, बल्कि पूरी दुनिया के लिए अपूरणीय क्षति है। \"इंडोनेशियाई राष्ट्रपति सुसीलो बम्बनग युधोयोनो, मलेशिया के प्रधानमंत्री नजीब रजाक, सिंगापुर के प्रधानमंत्री ली सियन लूंग , संयुक्त अरब अमीरात के राष्ट्रपति शेख खलीफा बिन जायद अल नहयान सहित अन्य अंतरराष्ट्रीय नेताओं,, और संयुक्त अरब अमीरात के प्रधानमंत्री और दुबई के शासक ने भी कलाम को श्रद्धांजलि अर्पित की। रूसी राष्ट्रपति व्लादिमीर पुतिन ने भारत सरकार, भारत के सभी लोगों के लिए और मृतक नेता ले प्रियजनों के लिए अपनी गंभीर संवेदना व्यक्त की और अपनी सहानुभूति और समर्थन से अवगत कराते हुए कहा, \"कलाम को हमारे देशों के बीच लगातार मैत्रीपूर्ण संबंधों के एक प्रतिपादक के रूप में याद किया जाएगा, उन्होंने भारत की राष्ट्रीय सुरक्षा को सुनिश्चित करने में सामाजिक, आर्थिक, वैज्ञानिक और तकनीकी प्रगति के लिए व्यक्तिगत योगदान दिया। उन्होंने  पारस्परिक रूप से लाभप्रद रूसी-भारतीय सहयोग जोड़ने के लिए बहुत कुछ किया। \"संयुक्त राज्य अमेरिका के राष्ट्रपति बराक ओबामा ने कहा,\" अमेरिकी लोगों की ओर से, मैं पूर्व भारतीय राष्ट्रपति ए॰पी॰जे॰ अब्दुल कलाम के निधन पर भारत के लोगों के लिए अपनी गहरी संवेदना का विस्तार करना चाहता हूँ। एक वैज्ञानिक और राजनेता, कलाम ने अपनी विनम्रता से घर में और विदेशों में सम्मान कमाया और भारत के सबसे महान नेताओं में से एक बने। भारत-अमेरिका के मजबूत संबंधों के लिए, डा कलाम ने सदा वकालत की। 1962 में संयुक्त राज्य अमेरिका की यात्रा के दौरान नासा के साथ अंतरिक्ष सहयोग को गहरा करने के लिए काम किया।"""
    
    # Count the number of sentences in the context
    num_sentences = len(re.split(r'[.!?]', context)) - 1  # Subtracting 1 to account for the last split which may not be a full sentence
    
    generated_qa_pairs = bot.generate_qa(context, num_pairs=2*num_sentences)
    print(generated_qa_pairs)
    bot.save_to_json(context, generated_qa_pairs, "generated_qa_pairs.json")

